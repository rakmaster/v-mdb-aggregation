(function(_,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],e):(_=typeof globalThis<"u"?globalThis:_||self,e(_.VMongoAggregationBuilder={},_.Vue))})(this,(function(_,e){"use strict";const j=new Set(["$sum","$avg","$min","$max","$count","$first","$last","$push","$addToSet","$stdDevPop","$stdDevSamp"]),x=new Set(["$addFields","$bucket","$bucketAuto","$changeStream","$changeStreamSplitLargeEvent","$collStats","$count","$currentOp","$densify","$documents","$facet","$fill","$geoNear","$graphLookup","$group","$indexStats","$limit","$listLocalSessions","$listSessions","$lookup","$match","$merge","$out","$planCacheStats","$project","$redact","$replaceRoot","$replaceWith","$sample","$search","$searchMeta","$set","$setWindowFields","$shardedDataDistribution","$skip","$sort","$sortByCount","$unionWith","$unset","$unwind"]);function M(o){const t={isValid:!0,errors:[],warnings:[]};let n;try{n=JSON.parse(o)}catch(s){return t.isValid=!1,t.errors.push({type:"json",message:`Invalid JSON: ${s instanceof Error?s.message:"Unknown parsing error"}`,position:{line:R(o,s),column:G(o,s)}}),t}return Array.isArray(n)?(n.forEach((s,a)=>{P(s,a,t)}),z(n,t),t):(t.isValid=!1,t.errors.push({type:"structure",message:"Aggregation pipeline must be an array of stage objects"}),t)}function P(o,t,n){if(typeof o!="object"||o===null||Array.isArray(o)){n.isValid=!1,n.errors.push({type:"structure",message:`Stage ${t+1} must be an object`,position:{stageIndex:t}});return}const s=Object.keys(o);s.length!==1&&(n.isValid=!1,n.errors.push({type:"structure",message:`Stage ${t+1} must have exactly one key (stage name)`,position:{stageIndex:t}}));const a=s[0];if(!a||!a.startsWith("$")){n.isValid=!1,n.errors.push({type:"stage",message:`Stage ${t+1}: Stage name "${a||"undefined"}" must start with $`,position:{stageIndex:t}});return}x.has(a)||n.warnings.push({type:"compatibility",message:`Stage ${t+1}: Unrecognized stage "${a}" - may not be supported in all MongoDB versions`,position:{stageIndex:t}});const i=o[a];J(a,i,t,n)}function J(o,t,n,s){switch(o){case"$match":T(t,n,s);break;case"$group":A(t,n,s);break;case"$project":case"$addFields":case"$set":D(t,n,s);break;case"$sort":U(t,n,s);break;case"$limit":case"$skip":F(t,n,s);break;case"$unwind":L(t,n,s);break;case"$lookup":q(t,n,s);break;default:W(t,n,s)}}function T(o,t,n){(typeof o!="object"||o===null)&&n.errors.push({type:"structure",message:`Stage ${t+1} ($match): Must be an object with query conditions`,position:{stageIndex:t}})}function A(o,t,n){if(typeof o!="object"||o===null){n.errors.push({type:"structure",message:`Stage ${t+1} ($group): Must be an object with _id and accumulator fields`,position:{stageIndex:t}});return}o.hasOwnProperty("_id")||n.errors.push({type:"structure",message:`Stage ${t+1} ($group): Missing required _id field`,position:{stageIndex:t}}),Object.entries(o).forEach(([s,a])=>{if(s!=="_id"&&typeof a=="object"&&a!==null){const i=Object.keys(a);if(i.length>0){const r=i[0];r&&r.startsWith("$")&&!j.has(r)&&n.warnings.push({type:"compatibility",message:`Stage ${t+1} ($group): Unrecognized accumulator operator "${r}"`,position:{stageIndex:t}})}}})}function D(o,t,n){(typeof o!="object"||o===null)&&n.errors.push({type:"structure",message:`Stage ${t+1}: Projection stage must be an object mapping field names to expressions`,position:{stageIndex:t}})}function U(o,t,n){if(typeof o!="object"||o===null){n.errors.push({type:"structure",message:`Stage ${t+1} ($sort): Must be an object mapping field names to sort directions (1 or -1)`,position:{stageIndex:t}});return}Object.entries(o).forEach(([s,a])=>{a!==1&&a!==-1&&n.errors.push({type:"structure",message:`Stage ${t+1} ($sort): Field "${s}" must have sort direction 1 (ascending) or -1 (descending), got ${a}`,position:{stageIndex:t}})})}function F(o,t,n){(typeof o!="number"||o<0||!Number.isInteger(o))&&n.errors.push({type:"structure",message:`Stage ${t+1}: Must be a non-negative integer`,position:{stageIndex:t}})}function L(o,t,n){typeof o=="string"?o.startsWith("$")||n.warnings.push({type:"best-practice",message:`Stage ${t+1} ($unwind): Field path should start with $`,position:{stageIndex:t}}):typeof o=="object"&&o!==null?o.path||n.errors.push({type:"structure",message:`Stage ${t+1} ($unwind): Missing required "path" field`,position:{stageIndex:t}}):n.errors.push({type:"structure",message:`Stage ${t+1} ($unwind): Must be a string field path or object with path property`,position:{stageIndex:t}})}function q(o,t,n){if(typeof o!="object"||o===null){n.errors.push({type:"structure",message:`Stage ${t+1} ($lookup): Must be an object with lookup configuration`,position:{stageIndex:t}});return}o.from||n.errors.push({type:"structure",message:`Stage ${t+1} ($lookup): Missing required "from" field`,position:{stageIndex:t}}),o.as||n.errors.push({type:"structure",message:`Stage ${t+1} ($lookup): Missing required "as" field`,position:{stageIndex:t}})}function W(o,t,n){o==null&&n.errors.push({type:"structure",message:`Stage ${t+1}: Stage value cannot be null or undefined`,position:{stageIndex:t}})}function z(o,t){const n=o.findIndex(i=>"$match"in i);n>0&&t.warnings.push({type:"performance",message:"Consider moving $match stage earlier in pipeline for better performance",position:{stageIndex:n}}),o.filter(i=>"$sort"in i).length>1&&t.warnings.push({type:"performance",message:"Multiple $sort stages detected - consider combining them",position:{}}),o.map((i,r)=>({stage:i,index:r})).filter(i=>"$limit"in i.stage).forEach(({stage:i,index:r})=>{let m=!1;for(let u=0;u<r;u++)if("$sort"in o[u]){m=!0;break}m||t.warnings.push({type:"best-practice",message:"$limit without preceding $sort may return unpredictable results",position:{stageIndex:r}})})}function R(o,t){if(t instanceof SyntaxError&&"message"in t){const n=t.message.match(/at position (\d+)/);if(n&&n[1]){const s=parseInt(n[1]);return o.substring(0,s).split(`
`).length}}}function G(o,t){if(t instanceof SyntaxError&&"message"in t){const n=t.message.match(/at position (\d+)/);if(n&&n[1]){const s=parseInt(n[1]),a=o.substring(0,s).split(`
`),i=a[a.length-1];return i?i.length:void 0}}}const K={class:"stage-info"},Q={class:"stage-number"},H={class:"stage-actions"},X={key:0,class:"validation-errors mt-2"},Y={key:1,class:"stage-preview mt-4"},Z=e.defineComponent({__name:"VStageCard",props:{stage:{},index:{},totalStages:{}},emits:["update","delete","move-up","move-down"],setup(o,{emit:t}){const n=o,s=t,a=e.ref(""),i=e.ref(""),r=e.ref([]),m=[{title:"$match",value:"$match"},{title:"$group",value:"$group"},{title:"$project",value:"$project"},{title:"$sort",value:"$sort"},{title:"$limit",value:"$limit"},{title:"$skip",value:"$skip"},{title:"$count",value:"$count"},{title:"$unwind",value:"$unwind"},{title:"$lookup",value:"$lookup"},{title:"$addFields",value:"$addFields"},{title:"$set",value:"$set"},{title:"$unset",value:"$unset"},{title:"$replaceRoot",value:"$replaceRoot"},{title:"$facet",value:"$facet"},{title:"$bucket",value:"$bucket"},{title:"$bucketAuto",value:"$bucketAuto"},{title:"$sortByCount",value:"$sortByCount"},{title:"$graphLookup",value:"$graphLookup"},{title:"$unionWith",value:"$unionWith"},{title:"$search",value:"$search"},{title:"$searchMeta",value:"$searchMeta"},{title:"$out",value:"$out"},{title:"$merge",value:"$merge"}],u=e.computed(()=>r.value.length>0),S=e.computed(()=>{try{return JSON.parse(i.value)}catch{return null}}),f=d=>Object.keys(d)[0]||"Unknown",V=d=>{try{const c=JSON.parse(i.value),w={[d]:c[Object.keys(c)[0]]||{}};i.value=JSON.stringify(w,null,2),k()}catch{const c={[d]:{}};i.value=JSON.stringify(c,null,2),k()}},b=()=>{r.value=[],k()},k=()=>{try{const d=JSON.parse(i.value);s("update",n.index,d)}catch{r.value=["Invalid JSON syntax"]}};return e.watch(()=>n.stage,d=>{a.value=Object.keys(d)[0]||"",i.value=JSON.stringify(d,null,2),r.value=[]},{immediate:!0}),(d,c)=>{const w=e.resolveComponent("v-chip"),h=e.resolveComponent("v-spacer"),C=e.resolveComponent("v-btn"),y=e.resolveComponent("v-card-title"),l=e.resolveComponent("v-select"),p=e.resolveComponent("v-textarea"),N=e.resolveComponent("v-alert"),E=e.resolveComponent("v-divider"),O=e.resolveComponent("v-code"),v=e.resolveComponent("v-card-text"),$=e.resolveComponent("v-card");return e.openBlock(),e.createBlock($,{class:"stage-card",elevation:"2"},{default:e.withCtx(()=>[e.createVNode(y,{class:"stage-header"},{default:e.withCtx(()=>[e.createElementVNode("div",K,[e.createElementVNode("span",Q,"Stage "+e.toDisplayString(o.index+1),1),e.createVNode(w,{size:"small",color:"primary",variant:"outlined"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(f(o.stage)),1)]),_:1})]),e.createVNode(h),e.createElementVNode("div",H,[o.index>0?(e.openBlock(),e.createBlock(C,{key:0,icon:"mdi-arrow-up",size:"small",variant:"text",onClick:c[0]||(c[0]=g=>d.$emit("move-up",o.index))})):e.createCommentVNode("",!0),o.index<o.totalStages-1?(e.openBlock(),e.createBlock(C,{key:1,icon:"mdi-arrow-down",size:"small",variant:"text",onClick:c[1]||(c[1]=g=>d.$emit("move-down",o.index))})):e.createCommentVNode("",!0),e.createVNode(C,{icon:"mdi-delete",size:"small",color:"error",variant:"text",onClick:c[2]||(c[2]=g=>d.$emit("delete",o.index))})])]),_:1}),e.createVNode(v,null,{default:e.withCtx(()=>[e.createVNode(l,{modelValue:a.value,"onUpdate:modelValue":[c[3]||(c[3]=g=>a.value=g),V],items:m,label:"Stage Type",density:"compact"},null,8,["modelValue"]),e.createVNode(p,{modelValue:i.value,"onUpdate:modelValue":[c[4]||(c[4]=g=>i.value=g),b],class:e.normalizeClass({"v-text-field--error":u.value}),label:"Stage Configuration (JSON)",placeholder:'{"$match": {"status": "active"}}',rows:"8","auto-grow":""},null,8,["modelValue","class"]),u.value?(e.openBlock(),e.createElementBlock("div",X,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(r.value,g=>(e.openBlock(),e.createBlock(N,{key:g,type:"error",density:"compact",class:"mb-1"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(g),1)]),_:2},1024))),128))])):e.createCommentVNode("",!0),S.value&&Object.keys(S.value).length>0?(e.openBlock(),e.createElementBlock("div",Y,[e.createVNode(E,{class:"mb-3"}),c[5]||(c[5]=e.createElementVNode("h4",{class:"text-h6 mb-2"},"Preview",-1)),e.createVNode(O,null,{default:e.withCtx(()=>[e.createElementVNode("pre",null,e.toDisplayString(JSON.stringify(S.value,null,2)),1)]),_:1})])):e.createCommentVNode("",!0)]),_:1})]),_:1})}}}),B=(o,t)=>{const n=o.__vccOpts||o;for(const[s,a]of t)n[s]=a;return n},I=B(Z,[["__scopeId","data-v-9be1934d"]]),ee={class:"v-output-panel"},te=B(e.defineComponent({__name:"VOutputPanel",props:{pipeline:{}},setup(o){const t=o,n=e.ref("json"),s=e.computed(()=>JSON.stringify(t.pipeline,null,2)),a=e.computed(()=>`db.collection.aggregate(${JSON.stringify(t.pipeline,null,2)})`);return(i,r)=>{const m=e.resolveComponent("v-card-title"),u=e.resolveComponent("v-tab"),S=e.resolveComponent("v-tabs"),f=e.resolveComponent("v-code"),V=e.resolveComponent("v-window-item"),b=e.resolveComponent("v-window"),k=e.resolveComponent("v-card-text"),d=e.resolveComponent("v-card");return e.openBlock(),e.createElementBlock("div",ee,[e.createVNode(d,{elevation:"1",class:"mt-6"},{default:e.withCtx(()=>[e.createVNode(m,null,{default:e.withCtx(()=>[...r[2]||(r[2]=[e.createTextVNode("Output",-1)])]),_:1}),e.createVNode(k,null,{default:e.withCtx(()=>[e.createVNode(S,{modelValue:n.value,"onUpdate:modelValue":r[0]||(r[0]=c=>n.value=c),color:"primary"},{default:e.withCtx(()=>[e.createVNode(u,{value:"json"},{default:e.withCtx(()=>[...r[3]||(r[3]=[e.createTextVNode("JSON Pipeline",-1)])]),_:1}),e.createVNode(u,{value:"query"},{default:e.withCtx(()=>[...r[4]||(r[4]=[e.createTextVNode("MongoDB Query",-1)])]),_:1})]),_:1},8,["modelValue"]),e.createVNode(b,{modelValue:n.value,"onUpdate:modelValue":r[1]||(r[1]=c=>n.value=c),class:"mt-4"},{default:e.withCtx(()=>[e.createVNode(V,{value:"json"},{default:e.withCtx(()=>[e.createVNode(f,null,{default:e.withCtx(()=>[e.createElementVNode("pre",null,e.toDisplayString(s.value),1)]),_:1})]),_:1}),e.createVNode(V,{value:"query"},{default:e.withCtx(()=>[e.createVNode(f,null,{default:e.withCtx(()=>[e.createElementVNode("pre",null,e.toDisplayString(a.value),1)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})])}}}),[["__scopeId","data-v-5d0e1608"]]),oe={class:"v-mongo-aggregation-builder"},ne={class:"toolbar mb-4"},ae={key:0,class:"stages-view"},se={class:"stage-list"},ie={key:1,class:"text-view"},re={key:0,class:"validation-errors mt-2"},le=B(e.defineComponent({__name:"VMongoAggregationBuilder",props:{initialPipeline:{default:()=>[]}},emits:["pipelineChange","exportPipeline"],setup(o,{emit:t}){const n=o,s=t,a=e.ref(n.initialPipeline||[]),i=e.ref("stages"),r=e.ref(""),m=e.ref([]),u=e.computed(()=>m.value.length>0),S=[{title:"Stages View",value:"stages"},{title:"Text View",value:"text"}],f=e.computed({get:()=>JSON.stringify(a.value,null,2),set:l=>{try{const p=JSON.parse(l);Array.isArray(p)&&(a.value=p,h())}catch{m.value=["Invalid JSON syntax"]}}}),V=()=>{a.value.push({$match:{status:"active"}}),y()},b=l=>{a.value.splice(l,1),h(),y()},k=(l,p)=>{a.value[l]=p,h(),y()},d=l=>{l>0&&([a.value[l-1],a.value[l]]=[a.value[l],a.value[l-1]],h(),y())},c=l=>{l<a.value.length-1&&([a.value[l],a.value[l+1]]=[a.value[l+1],a.value[l]],h(),y())},w=()=>{h(),y()},h=()=>{m.value=[];const l=M(f.value);l.isValid||(m.value=l.errors.map(p=>p.message)),l.warnings.length>0&&l.warnings.forEach(p=>{m.value.push(`Warning: ${p.message}`)})},C=()=>{s("exportPipeline",a.value)},y=()=>{s("pipelineChange",a.value)};return(l,p)=>{const N=e.resolveComponent("v-btn"),E=e.resolveComponent("v-select"),O=e.resolveComponent("v-textarea"),v=e.resolveComponent("v-alert");return e.openBlock(),e.createElementBlock("div",oe,[e.createElementVNode("div",ne,[e.createVNode(N,{onClick:V,color:"primary","prepend-icon":"mdi-plus"},{default:e.withCtx(()=>[...p[2]||(p[2]=[e.createTextVNode(" Add Stage ",-1)])]),_:1}),e.createVNode(N,{onClick:C,variant:"outlined","prepend-icon":"mdi-download"},{default:e.withCtx(()=>[...p[3]||(p[3]=[e.createTextVNode(" Export Pipeline ",-1)])]),_:1}),e.createVNode(E,{modelValue:i.value,"onUpdate:modelValue":p[0]||(p[0]=$=>i.value=$),items:S,label:"View Mode",density:"compact",style:{"max-width":"200px"}},null,8,["modelValue"])]),i.value==="stages"?(e.openBlock(),e.createElementBlock("div",ae,[e.createElementVNode("div",se,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(a.value,($,g)=>(e.openBlock(),e.createBlock(I,{key:g,stage:$,index:g,"total-stages":a.value.length,onUpdate:k,onDelete:b,onMoveUp:d,onMoveDown:c},null,8,["stage","index","total-stages"]))),128))])])):(e.openBlock(),e.createElementBlock("div",ie,[e.createVNode(O,{modelValue:f.value,"onUpdate:modelValue":[p[1]||(p[1]=$=>f.value=$),w],class:e.normalizeClass({"text-error":u.value}),label:"Aggregation Pipeline JSON",placeholder:"Paste your aggregation pipeline JSON here...",rows:"15","auto-grow":""},null,8,["modelValue","class"]),u.value?(e.openBlock(),e.createElementBlock("div",re,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(m.value,$=>(e.openBlock(),e.createBlock(v,{key:$,type:"error",density:"compact",class:"mb-1"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString($),1)]),_:2},1024))),128))])):e.createCommentVNode("",!0)])),r.value?(e.openBlock(),e.createBlock(v,{key:2,type:"error",class:"mt-4"},{default:e.withCtx(()=>[p[4]||(p[4]=e.createElementVNode("strong",null,"Error:",-1)),e.createTextVNode(" "+e.toDisplayString(r.value),1)]),_:1})):e.createCommentVNode("",!0),e.createVNode(te,{pipeline:a.value},null,8,["pipeline"])])}}}),[["__scopeId","data-v-681c9c9e"]]);_.VMongoAggregationBuilder=le,Object.defineProperty(_,Symbol.toStringTag,{value:"Module"})}));
